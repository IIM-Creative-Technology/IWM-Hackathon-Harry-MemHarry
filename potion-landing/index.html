<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POC</title>
  <style>
    @font-face {
      font-family: 'ringbearermedium';
      src: url('/assets/font/webfont/ringbearermedium-51mgz-webfont.woff2') format('woff2'),
      url('/assets/font/webfont/ringbearermedium-51mgz-webfont.woff') format('woff');
      font-weight: normal;
      font-style: normal;

    }

    body {
      margin: 0;
      overflow: hidden;
    }
    canvas {
      top: 0;
      left: 0;
      position: fixed;
      z-index: -1;
    }
    a {
      font-family: 'ringbearermedium',sans-serif;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 15rem;
      color: goldenrod;
      text-decoration: none;
    }
    a:hover {
      text-shadow: 0 0 10px goldenrod;
    }
  </style>
</head>
<body>
<canvas id="bg"></canvas>
<a href="http://localhost:8080">Start</a>
</body>

<script type="module">
  import * as THREE from 'three';
  import { STLLoader } from 'three/examples/jsm/loaders/STLLoader';
  import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';
  import { TransformControls } from "three/addons/controls/TransformControls.js";

  import mainbg from './assets/main.jpg';
  import titleTexture from './assets/titleTexture.jpg';
  import titleModel from './assets/models/title.STL?url';
  import potionModel from './assets/models/potion/scene.gltf?url';
  import cauldronModel from './assets/models/cauldron/scene.gltf?url';
  import hagridModel from './assets/models/hagrid/hagrid.glb?url';

  const scene = new THREE.Scene();

  const textureLoader = new THREE.TextureLoader();
  const mainTexture = textureLoader.load(mainbg);
  scene.background = mainTexture;

  // create semi-transparent plane
    const planeGeometry = new THREE.PlaneGeometry(100, 100, 1, 1);
    const planeMaterial = new THREE.MeshBasicMaterial({
      color: 0x000000,
      opacity: 0.5,
      transparent: true,
      side: THREE.DoubleSide
    });
    const plane = new THREE.Mesh(planeGeometry, planeMaterial);
    plane.position.set(0, 0, -1);
    scene.add(plane);

  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({
    canvas: document.querySelector('#bg'),
    antialias: false
  });

  renderer.setPixelRatio( window.devicePixelRatio * 0.5 );
  renderer.setSize( window.innerWidth, window.innerHeight );
  camera.position.setZ(10);
  renderer.render( scene, camera );

  const ModelControls = new TransformControls(camera, renderer.domElement);

  const material = new THREE.MeshStandardMaterial({
    map: new THREE.TextureLoader().load(titleTexture),
  })

  const stlLoader = new STLLoader();
  const gltfLoader = new GLTFLoader();

  let title;
  let promise = stlLoader.loadAsync(titleModel);
  promise.then(
      function (geometry) {
          const mesh = new THREE.Mesh(geometry, material);
          mesh.position.set(-7, 2, 0);
          mesh.scale.set(0.03, 0.03, 0.03);

          scene.add(mesh);

          title = mesh;
      }
  )

  let potion;
  gltfLoader.load(
      potionModel,
      function (gltf) {
        potion = gltf.scene;
        potion.position.set(10, -3, 0);
        potion.rotation.set(0, 1, 0);
        potion.scale.set(0.007, 0.007, 0.007);
        scene.add(potion);

        const glow = new THREE.PointLight(0x0000ff, 1, 100);
        glow.position.set(0, 0, 0);
        glow.intensity = 2;
        glow.decay = 10;
        potion.add(glow);
    }
  );

  let cauldron;
  gltfLoader.load(
      cauldronModel,
      function (gltf) {
        cauldron = gltf.scene;
        cauldron.position.set(-10, -2, 0);
        cauldron.rotation.set(0, 1, 0);
        cauldron.scale.set(1.5, 1.5, 1.5);
        cauldron.rotation.set(0.2, 0, -0.2);

        const glow = new THREE.PointLight(0x00ff00, 1, 100);
        glow.position.set(0, 0, 0);
        glow.intensity = 1;
        glow.decay = 10;
        cauldron.add(glow);

        scene.add(cauldron);
      }
  );

  let hagrid;
  async function loadHagrid() {
    const hagridData = await gltfLoader.loadAsync(hagridModel);

    hagrid = hagridData.scene;
    hagrid.position.set(0, -12, 0);
    hagrid.scale.set(0.0007, 0.0007, 0.0007);

    const glow = new THREE.PointLight(0xff0000, 1, 100);
    glow.position.set(0, 0, 0);
    glow.intensity = 1;
    glow.decay = 10;
    hagrid.add(glow);

    scene.add(hagrid);
  }

  loadHagrid();

  const backLight = new THREE.PointLight(0xffffff);
  backLight.position.set(0, 5, 0);
  backLight.intensity = 2;
  scene.add(backLight);

  const frontLightL = new THREE.PointLight(0xffffff);
  frontLightL.position.set(-4, 5, 2);
  frontLightL.intensity = 0.7;
  frontLightL.decay = 10;
  scene.add(frontLightL);

  const frontLightR = new THREE.PointLight(0xffffff);
  frontLightR.position.set(4, 5, 2);
  frontLightR.intensity = 0.7;
  frontLightR.decay = 10;
  scene.add(frontLightR);

  const ambientLight = new THREE.AmbientLight(0xffffff);
  ambientLight.intensity = 0.3;
  scene.add(ambientLight);

  const gridHelper = new THREE.GridHelper(50, 50);
  gridHelper.rotation.x = Math.PI / 2;
  // scene.add(gridHelper);

  scene.add(ModelControls);

  window.addEventListener('keydown', (e) => {
    switch (e.key) {
      case 'w':
        ModelControls.setMode('translate');
        break;
      case 'e':
        ModelControls.setMode('rotate');
        break;
      case 'r':
        ModelControls.setMode('scale');
        break;
    }
  });

  function animate(){
    requestAnimationFrame(animate);

    if (title) {
        title.position.y = 1.5 + Math.sin(Date.now() / 1000) * 0.2;
        title.position.x = -7 + Math.cos(Date.now() / 1000) * 0.2;
    }

    if (potion) {
        potion.position.y = -3 + Math.sin(Date.now() / 1000) * 0.1;
        potion.position.x = 10 + Math.sin(Date.now() / 1000) * 0.06;
    }

    if (cauldron) {
      cauldron.position.y = -2 + Math.sin(Date.now() / 1000) * 0.1;
      cauldron.position.x = -10 + Math.sin(Date.now() / 1000) * 0.06;
      cauldron.rotation.y += 0.001;
    }

    if (hagrid) {
        hagrid.position.y = -12 + Math.cos(Date.now() / 1000) * 0.05;
    }

    renderer.render(scene, camera);
  }

  animate()
</script>
</html>
